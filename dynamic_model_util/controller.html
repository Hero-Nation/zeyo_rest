<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>컨트롤러 시뮬레이터</title>
<script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script>
<script src="algebra-0.2.6.min.js" ></script>
<script src="svg.js"></script>
<script>

    var Fraction = algebra.Fraction;
    var Expression = algebra.Expression;
    var Equation = algebra.Equation;

	var dm = dm || {};
	
	var MAIN_CANVAS = null;
	
 
	var import_model = function() {
		
		if (MAIN_CANVAS != null) {
			MAIN_CANVAS.clear();
		} else {
			MAIN_CANVAS = SVG('MAIN_CANVAS');
		}
		
		dm = $("#input_dm").val();
		dm = $.trim(dm);
		if (dm == "") {
			alert("수치 모델을 입력해주세요!");
			return;
		}
		dm = JSON.parse(dm);

		draw_model(dm);
		
	};

	var export_model = function() {


		
	};

	var move_center = function() {

		var center_x = $("#center_x").val();
		var center_y = $("#center_y").val();
		var center_ratio = $("#center_ratio").val();
		
		if(center_x == null){
			alert("새로운 중심점 X 값을 넣어주세요!");
			return;
		}
		
		if(center_y == null){
			alert("새로운 중심점 Y 값을 넣어주세요!");
			return;
		}
		
		if(center_ratio == null){
			alert("새로운 비율 값을 넣어주세요!");
			return;
		}
		
		var move_gap = {};
		
		move_gap.x = center_x - dm.center.x;
		move_gap.y = center_y - dm.center.y;
		
		var clone_dm = $.extend(true, {}, dm); 
				
		for ( var data_index in clone_dm.dynamic_model_element) {
			var element = clone_dm.dynamic_model_element[data_index];	
			clone_dm.dynamic_model_element[data_index] = move_element_data(element, move_gap);
		}
		
		draw_model(clone_dm);
		
	};

	var draw_model = function(p_dynamic_model) {

		
		MAIN_CANVAS.clear();
		
		var element_data = p_dynamic_model.dynamic_model_element;

		for ( var data_index in element_data) {
			
			var element = element_data[data_index];
			var flat_data = flat_element_data(element); 
			
			if(element.type == "path"){
			 
			 
				var path = MAIN_CANVAS.path(flat_data);
				path.fill('none');
				path.stroke({ color: '#60f', width: 2, linecap: 'round', linejoin: 'round' });
			 
			 
			}else if(element.type == "line"){
				
				var line = MAIN_CANVAS.line(flat_data).stroke({ color: '#f06',  width: 2 });
				
				
			}
		}

	};
	
	var get_point_by_ratio = function(p_center,p_original_point,p_ratio){
 
		var d = new Date();
		var start = d.getMilliseconds();
		
		var target_x = null;
		var target_y = null;
		
		console.log("시작점 ");
		console.log(p_center);
		
		
		console.log("끝점 ");
		console.log(p_original_point);
		
		
		
		// scale 적용전의 두점을 거리를 구한다.
		
		var original_length = distants_on_two_point(p_center,p_original_point);
		
		// scale이 적용된 거리
		
		var scale_length = original_length * p_ratio;
		var scale_length_pow = Math.floor(scale_length * scale_length );
		
		var x1 = Number(p_center.x);
		var y1 = Number(p_center.y);
		
		var x2 = Number(p_original_point.x);
		var y2 = Number(p_original_point.y);
		
		
		console.log("두점의 길이 ");
		console.log(scale_length);
		console.log("두점의 길이의 제곱 ");
		console.log(scale_length_pow);
		
		// 방정식 1 : 두점을 지나는 직선의 방정식
		
		/*
		
		eq1 = ((y2-y1)/(x2-x1))*(x - x1) + y1;
 
		*/
		
		var expr1_str = " ( ( "  +y2 + " -  "  +y1 + " ) / ( "  +x2 + " - "  +x1 + " ) ) * ( x - "  +x1 + " ) + "  +y1;
		
		if(x2 == x1){
			expr1_str =  " ( 0 + "+y1+" ) ";
		}
		
		
		var expr1 = algebra.parse(expr1_str); 
		console.log("방정식 1 ");
		console.log(expr1.toString()); 
		
		// 방정식 2 : 두점의 거리를 이용한 방정식
		
		/*
		
		
			scale_length_pow =  (x - x1) * (x - x1) + (y - y1) *  (y - y1);
		
 
		*/
		
		var expr2_str ="(x - "  +x1 + ") * (x - "  +x1 + ") + (y - "  +y1 + ") *  (y - "  +y1 + ")";
		var expr2 = algebra.parse(expr2_str);
		
		console.log("방정식 2 ");
		console.log(expr2.toString());
		var eq = new Equation(expr2,scale_length_pow);
		
		eq = eq.eval({y: expr1});
		console.log("대입 ");
		console.log(eq.toString());
		
		
		var new_lhs = algebra.parse(eq.lhs.toString());
		console.log("좌측항 ");
		console.log(new_lhs.toString());
		var eq = new Equation(new_lhs,scale_length_pow);
		console.log(eq.toString());
		
		var eq_answer = eq.solveFor("x");
		console.log("결과 ");
		console.dir(eq_answer);
		
		var answer_x = 0;
		
		if(x1 <= x2){
		
			if(eval(eq_answer[0].toString()) > x1){
				answer_x = eval(eq_answer[0].toString());
			}else if(eval(eq_answer[1].toString()) > x1){
				answer_x = eval(eq_answer[1].toString());
			}
			
			 
			
		}else{
			
			if(eval(eq_answer[0].toString()) < x1){
				answer_x = eval(eq_answer[0].toString());
			}else if(eval(eq_answer[1].toString()) < x1){
				answer_x = eval(eq_answer[1].toString());
			}
			
		}
		
		console.log("결과 X");
		console.dir(answer_x);
		
		var ex_x =  new Expression(""+(answer_x < 0 ? "-"+answer_x :answer_x  ) );
		console.log(ex_x.toString());
		
		var expr1_str = "";
		if(x2 != x1){
			var part_rxpr1 = expr1.toString().split("x");
			
			if($.trim(part_rxpr1[0]) == ""){
				part_rxpr1[0] = 1;
			}
			
			expr1_str = part_rxpr1[0] + " * "+ex_x.toString() +part_rxpr1[1]
		} 
		
		console.dir(expr1_str);
		
		var d = new Date();
		var end = d.getMilliseconds();
		
		console.log("execution time : "+(end - start) + " ms");
		
		return {
			x : answer_x,
			y : eval(expr1_str.toString())
		};
		
	};
	
	 
	var get_point_by_extension = function(p_center,p_original_point,p_extension){
 
		var d = new Date();
		var start = d.getMilliseconds();
		
		var target_x = null;
		var target_y = null;
		
		console.log("시작점 ");
		console.log(p_center);
		
		
		console.log("끝점 ");
		console.log(p_original_point);
		
		
		
		// scale 적용전의 두점을 거리를 구한다.
		
		var original_length = distants_on_two_point(p_center,p_original_point);
		
		// scale이 적용된 거리
		
		var scale_length = original_length + p_extension;
		var scale_length_pow = Math.floor(scale_length * scale_length );
		
		var x1 = Number(p_center.x);
		var y1 = Number(p_center.y);
		
		var x2 = Number(p_original_point.x);
		var y2 = Number(p_original_point.y);
		
		
		console.log("두점의 길이 ");
		console.log(scale_length);
		console.log("두점의 길이의 제곱 ");
		console.log(scale_length_pow);
		
		// 방정식 1 : 두점을 지나는 직선의 방정식
		
		/*
		
		eq1 = ((y2-y1)/(x2-x1))*(x - x1) + y1;
 
		*/
		
		var expr1_str = " ( ( "  +y2 + " -  "  +y1 + " ) / ( "  +x2 + " - "  +x1 + " ) ) * ( x - "  +x1 + " ) + "  +y1;
		
		if(x2 == x1){
			expr1_str =  " ( 0 + "+y1+" ) ";
		}
		
		
		var expr1 = algebra.parse(expr1_str); 
		console.log("방정식 1 ");
		console.log(expr1.toString()); 
		
		// 방정식 2 : 두점의 거리를 이용한 방정식
		
		/*
		
		
			scale_length_pow =  (x - x1) * (x - x1) + (y - y1) *  (y - y1);
		
 
		*/
		
		var expr2_str ="(x - "  +x1 + ") * (x - "  +x1 + ") + (y - "  +y1 + ") *  (y - "  +y1 + ")";
		var expr2 = algebra.parse(expr2_str);
		
		console.log("방정식 2 ");
		console.log(expr2.toString());
		var eq = new Equation(expr2,scale_length_pow);
		
		eq = eq.eval({y: expr1});
		console.log("대입 ");
		console.log(eq.toString());
		
		
		var new_lhs = algebra.parse(eq.lhs.toString());
		console.log("좌측항 ");
		console.log(new_lhs.toString());
		var eq = new Equation(new_lhs,scale_length_pow);
		console.log(eq.toString());
		
		var eq_answer = eq.solveFor("x");
		console.log("결과 ");
		console.dir(eq_answer);
		
		var answer_x = 0;
		
		if(x1 <= x2){
		
			if(eval(eq_answer[0].toString()) > x1){
				answer_x = eval(eq_answer[0].toString());
			}else if(eval(eq_answer[1].toString()) > x1){
				answer_x = eval(eq_answer[1].toString());
			}
			
			 
			
		}else{
			
			if(eval(eq_answer[0].toString()) < x1){
				answer_x = eval(eq_answer[0].toString());
			}else if(eval(eq_answer[1].toString()) < x1){
				answer_x = eval(eq_answer[1].toString());
			}
			
		}
		
		console.log("결과 X");
		console.dir(answer_x);
		
		var ex_x =  new Expression(""+(answer_x < 0 ? "-"+answer_x :answer_x  ) );
		console.log(ex_x.toString());
		
		var expr1_str = "";
		if(x2 != x1){
			var part_rxpr1 = expr1.toString().split("x");
			
			if($.trim(part_rxpr1[0]) == ""){
				part_rxpr1[0] = 1;
			}
			
			expr1_str = part_rxpr1[0] + " * "+ex_x.toString() +part_rxpr1[1]
		} 
		
		console.dir(expr1_str);
		
		var d = new Date();
		var end = d.getMilliseconds();
		
		console.log("execution time : "+(end - start) + " ms");
		
		return {
			x : answer_x,
			y : eval(expr1_str.toString())
		};
		
	};
	 
	
	var distants_on_two_point = function(p_point1,p_point2){
		var x1 = Number(p_point1.x);
		var y1 = Number(p_point1.y);
		
		var x2 = Number(p_point2.x);
		var y2 = Number(p_point2.y);
		
		
		var d = ( (x2 - x1) * (x2 - x1) ) + ( ( y2 - y1 ) * ( y2 - y1 ) );
		return Math.sqrt(d);
	};
	
	var target_y_on_two_point_line = function(p_point1,p_point2,p_target_x){
		
		var x1 = Number(p_point1.x);
		var y1 = Number(p_point1.y);
		
		var x2 = Number(p_point2.x);
		var y2 = Number(p_point2.y);
	
		if(x1 == x2){
			
			if(x1 == p_target_x){
				
				return "all";
				
			}else{
				
				return "not";
				
			}
			
		}else if(y1 == y2){
			
			return "all";
			
		}else{
			
			var y = ((y2 - y1)/(x2 - x1))*(p_target_x - x1)+y1;
			
			return y;	
		}
	};
	
	var move_element_data = function(p_element,p_move_gap){


		
		var start_x = Number(p_element.start.x)  + p_move_gap.x;
		var start_y = Number(p_element.start.y)  + p_move_gap.y;
		
		p_element.start.x = start_x;
		p_element.start.y = start_y;
		
		var end_x = Number(p_element.end.x)  + p_move_gap.x;
		var end_y = Number(p_element.end.y)  + p_move_gap.y;
		
		p_element.end.x = end_x;
		p_element.end.y = end_y;
		
		
		var data = p_element.data;
		
		for ( var data_index in data) {
			
			var step_data = data[data_index];
			
			if (p_element.type == "path") {

				
				if (data_index == 0) {
					
				
					step_data[1] += p_move_gap.x;
					step_data[2] += p_move_gap.y;
					
				} else {

					if (step_data[0] == "L") {
						
						step_data[1] += p_move_gap.x;
						step_data[2] += p_move_gap.y;

					} else if (step_data[0] == "H") {
 
						step_data[1] += p_move_gap.x;

					} else if (step_data[0] == "V") {
						step_data[1] += p_move_gap.y;
						

					} else if (step_data[0] == "C") {

						step_data[1] += p_move_gap.x;
						step_data[2] += p_move_gap.y;
						step_data[3] += p_move_gap.x;
						step_data[4] += p_move_gap.y;
						step_data[5] += p_move_gap.x;
						step_data[6] += p_move_gap.y;
				  

					} else if (step_data[0] == "S") {

						step_data[1] += p_move_gap.x;
						step_data[2] += p_move_gap.y;
						step_data[3] += p_move_gap.x;
						step_data[4] += p_move_gap.y;

					} else if (step_data[0] == "Q") {

						step_data[1] += p_move_gap.x;
						step_data[2] += p_move_gap.y;
						step_data[3] += p_move_gap.x;
						step_data[4] += p_move_gap.y;

					} else if (step_data[0] == "T") {

						step_data[1] += p_move_gap.x;
						step_data[2] += p_move_gap.y;

					} else if (step_data[0] == "A") {
						console.log("A _____");
					} else if (step_data[0] == "Z") {
						console.log("A _____");
					}
					
					//R += " ";
					//R += "z";
				}

			} else if (p_element.type == "line") {
				
				if (data_index == 0) { 
					
					step_data[1] += p_move_gap.x;
					step_data[2] += p_move_gap.y;
					
				}else{ 
					
					step_data[1] += p_move_gap.x;
					step_data[2] += p_move_gap.y;
					
				}
				
			}
			
			data[data_index] = step_data;
			
		} // for ( var data_index in data) { 
		
		p_element.data = data;
		
		return p_element;
 
	}

	var flat_element_data = function(p_element) {

		var R = null;

		var data = p_element.data;

		for ( var data_index in data) {

			
			var step_data = data[data_index];
			console.dir(step_data);
			
			if (p_element.type == "path") {

				
				if (data_index == 0) {
					
					R = "M";
					R += step_data[1];
					R += " ";
					R += step_data[2];
					R += " ";

				} else {

					if (step_data[0] == "L") {

						R += "L";
						R += " ";
						R += step_data[1];
						R += " ";
						R += step_data[2];

					} else if (step_data[0] == "H") {

						R += "H";
						R += " ";
						R += step_data[1];

					} else if (step_data[0] == "V") {

						R += "V";
						R += " ";
						R += step_data[1];

					} else if (step_data[0] == "C") {

						R += "C";
						R += " ";
						R += step_data[1];
						R += " ";
						R += step_data[2];
						R += ",";
						R += step_data[3];
						R += " ";
						R += step_data[4];
						R += ",";
						R += step_data[5];
						R += " ";
						R += step_data[6];

					} else if (step_data[0] == "S") {

						R += "S";
						R += " ";
						R += step_data[1];
						R += " ";
						R += step_data[2];
						R += ",";
						R += step_data[3];
						R += " ";
						R += step_data[4];

					} else if (step_data[0] == "Q") {

						R += "Q";
						R += " ";
						R += step_data[1];
						R += " ";
						R += step_data[2];
						R += ",";
						R += step_data[3];
						R += " ";
						R += step_data[4];

					} else if (step_data[0] == "T") {

						R += "T";
						R += " ";
						R += step_data[1];
						R += " ";
						R += step_data[2];

					} else if (step_data[0] == "A") {
						console.log("A _____");
					} else if (step_data[0] == "Z") {
						console.log("A _____");
					}
					
					//R += " ";
					//R += "z";
				}

			} else if (p_element.type == "line") {
				
				
				
				if (data_index == 0) {
					
					/* R = [];
					R.push(step_data[1]);
					R.push(step_data[2]); */
					
					R = "";
					R += step_data[1];
					R += ",";
					R += step_data[2];
					
				}else{
					/* R.push(step_data[3]);
					R.push(step_data[4]); */
					
					R = " ";
					R += step_data[1];
					R += ",";
					R += step_data[2];
					
				}
				
				
			}
		}
		
		console.log(R);

		return R;

	};

	var mi_exe = function(p_target, p_op) {
		alert(p_target + " " + p_op);
	};
</script>
<style>
#MAIN_CANVAS {
	width: 900px;
	height: 900px;
	border: 1px solid black;
}

#maintable {
	width: 100%;
	height: 100%;
}

#back_green {
	background-color: green;
}
</style>
</head>
<body>
 <h1>컨트롤러 시뮬레이터</h1>
 <a href="dynamic_model_builder.html" target="_blank">수치 모델 빌더</a>
 <a href="http://jsbeautifier.org" target="_blank">beautifier</a>
 <a href="http://jsonviewer.stack.hu" target="_blank">jsonviewer</a>
 <table id="maintable">
  <tr>
   <td>
    <div>
     X 축 : <input type="text" id="center_x" value="450" /> 
     Y 축 : <input type="text" id="center_y" value="450" /> 
     비율 : <input type="text" id="center_ratio" value="1" />
     <button onclick="move_center();">중심축이동</button>
     <br>
    </div>
    <div id="MAIN_CANVAS"></div>
   </td>
   <td>
    <h3>수치모델 입력</h3>
    <button onclick="import_model();">불러들이기</button>

    <textarea id="input_dm" cols="135" rows="5"></textarea>
    <h3>수치모델 출력</h3>
        <button onclick="export_model();">내보내기</button>
    <textarea id="output_dm" cols="135" rows="5"></textarea>
    <h3>controller</h3> <textarea id="input_ctrl" cols="135" rows="10"></textarea>
    <h3>측정항목</h3>
    <div>
     이름 : <input type="text" id="mi_name_1" /> min : <input type="text" id="mi_min_1"> max : <input type="text" id="mi_max_1"> now : <input type="text" id="mi_now_1">
     <button onclick="mi_exe('1','up')">△</button>
     <button onclick="mi_exe('1','down')">▽</button>
     <br> 이름 : <input type="text" id="mi_name_2" /> min : <input type="text" id="mi_min_2"> max : <input type="text" id="mi_max_2"> now : <input type="text" id="mi_now_2">
     <button onclick="mi_exe('2','up')">△</button>
     <button onclick="mi_exe('2','down')">▽</button>
     <br> 이름 : <input type="text" id="mi_name_3" /> min : <input type="text" id="mi_min_3"> max : <input type="text" id="mi_max_3"> now : <input type="text" id="mi_now_3">
     <button onclick="mi_exe('3','up')">△</button>
     <button onclick="mi_exe('3','down')">▽</button>
     <br> 이름 : <input type="text" id="mi_name_4" /> min : <input type="text" id="mi_min_4"> max : <input type="text" id="mi_max_4"> now : <input type="text" id="mi_now_4">
     <button onclick="mi_exe('4','up')">△</button>
     <button onclick="mi_exe('4','down')">▽</button>
     <br> 이름 : <input type="text" id="mi_name_5" /> min : <input type="text" id="mi_min_5"> max : <input type="text" id="mi_max_5"> now : <input type="text" id="mi_now_5">
     <button onclick="mi_exe('5','up')">△</button>
     <button onclick="mi_exe('5','down')">▽</button>
     <br> 이름 : <input type="text" id="mi_name_6" /> min : <input type="text" id="mi_min_6"> max : <input type="text" id="mi_max_6"> now : <input type="text" id="mi_now_6">
     <button onclick="mi_exe('6','up')">△</button>
     <button onclick="mi_exe('6','down')">▽</button>
     <br> 이름 : <input type="text" id="mi_name_7" /> min : <input type="text" id="mi_min_7"> max : <input type="text" id="mi_max_7"> now : <input type="text" id="mi_now_6">
     <button onclick="mi_exe('6','up')">△</button>
     <button onclick="mi_exe('7','down')">▽</button>
     <br> 이름 : <input type="text" id="mi_name_8" /> min : <input type="text" id="mi_min_8"> max : <input type="text" id="mi_max_8"> now : <input type="text" id="mi_now_6">
     <button onclick="mi_exe('6','up')">△</button>
     <button onclick="mi_exe('8','down')">▽</button>
     <br> 이름 : <input type="text" id="mi_name_9" /> min : <input type="text" id="mi_min_9"> max : <input type="text" id="mi_max_9"> now : <input type="text" id="mi_now_6">
     <button onclick="mi_exe('6','up')">△</button>
     <button onclick="mi_exe('9','down')">▽</button>
     <br> 이름 : <input type="text" id="mi_name_10" /> min : <input type="text" id="mi_min_10"> max : <input type="text" id="mi_max_10"> now : <input type="text" id="mi_now_6">
     <button onclick="mi_exe('6','up')">△</button>
     <button onclick="mi_exe('10','down')">▽</button>
     <br>
    </div>
   </td>
  </tr>
 </table>
</body>
</html>